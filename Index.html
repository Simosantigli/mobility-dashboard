<!DOCTYPE html>
<html lang="en" data-color-scheme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trip Tracker ‚Äî Sustainable Mobility</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- Google Font --- */
    @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap');

    :root{

    /* --- Palette --- */
      --color-background: #F8F8FA;
      --color-surface: #FFFFFF;
      --color-text: #1F2937;
      --color-text-secondary: #6B7280;
      --color-primary: #4F46E5;
      --color-primary-hover: #4338CA;
      --color-border: #E5E7EB;
      --color-muted: #F3F4F6;

      /* --- Radii --- */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;   
      --radius-lg: 1rem;

      /* --- Shadows --- */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.06), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
      
      /* Timeline specific vars */
      --legend-width: 340px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      color:var(--color-text);
      background:var(--color-background);
      font-family: 'Lexend', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h1,h2,h3{ margin:0 0 .5rem; font-weight: 600; }
    h1 { font-size: 1.875rem; /* 30px */ }
    h2 { font-size: 1.5rem; /* 24px */ }
    h3 { font-size: 1.25rem; /* 20px */ }
    p{ margin:.5rem 0 1rem; line-height: 1.6; }

    /* --- Polish --- */
    .btn, .nav-btn, .form-control, .card {
      transition: all 0.15s ease-in-out;
    }
    .chart-card, .metric-card, .key-insights-card, .form-section, .dataset-container, .timeline-legend, .timeline-visualization, .filters-card {
      transition: box-shadow 0.15s ease-in-out, transform 0.15s ease-in-out;
    }
    .chart-card:hover, .metric-card:hover, .key-insights-card:hover, .form-section:hover, .dataset-container:hover, .timeline-legend:hover, .timeline-visualization:hover, .filters-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    /* Card transitions */
    .kpi-card-lg:hover, .kix-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    /* --- NAV --- */
    .main-nav{
      padding: 12px 24px;
      border-bottom: 1px solid var(--color-border);
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .nav-brand h1{ font-size: 1.5rem; margin-bottom: 0; color: var(--color-primary); }
    .nav-brand p{ color:var(--color-text-secondary); margin:0; font-size: 0.875rem; }
    .nav-links{ display:flex; gap:8px; }
    .nav-btn{
      padding: 8px 14px;
      border: 1px solid transparent;
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 500;
      color: var(--color-text-secondary);
    }
    .nav-btn.active, .nav-btn:hover{
      background: var(--color-muted);
      color: var(--color-text);
      border-color: var(--color-border);
    }

    /* --- LAYOUT --- */
    .app-container{ max-width:1200px; margin:0 auto; }
    .main-content{ padding: 24px; }
    .view{ display:none; }
    .view.active{ display:block; }
    .page-header{
      display:flex;
      justify-content:space-between;
      align-items:end;
      gap:16px;
      margin:0 0 16px;
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 16px;
    }

    /* --- FORM --- */
    .form-section{
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    .form-section h3{ margin-bottom: 16px; }
    .form-grid{
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
    }
    .form-group{ display:flex; flex-direction:column; gap:6px; }
    .form-group.full{ grid-column: 1 / -1; }
    .g-col-span-2 { grid-column: span 2; }
    .form-label{ font-weight: 500; font-size: 0.875rem; color: var(--color-text); }
    .form-control{
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      font-size: 1rem;
      font-family: 'Lexend', sans-serif;
    }
    .form-control:focus{
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-hover-light, rgba(79, 70, 229, 0.1));
    }
    .stress-slider-container { display: flex; align-items: center; gap: 12px; }
    .stress-slider { width: 100%; accent-color: var(--color-primary); }
    .stress-label { font-size: 0.875rem; color: var(--color-text-secondary); }
    .calculated-preview h3 { margin-bottom: 12px; }
    .calc-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      background: var(--color-muted);
      padding: 16px;
      border-radius: var(--radius-md);
    }
    .calc-item { display: flex; flex-direction: column; gap: 4px; }
    .calc-label { font-size: 0.875rem; color: var(--color-text-secondary); font-weight: 500; }
    .calc-value { font-size: 1.25rem; font-weight: 600; }
    .form-actions{ display:flex; gap:12px; margin-top: 16px; }
    .btn{
      padding: 10px 18px;
      border-radius: var(--radius-md);
      border: 0;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
    }
    .btn--primary{ background: var(--color-primary); color: white; }
    .btn--primary:hover{ background: var(--color-primary-hover); }
    .btn--secondary{ background: var(--color-muted); color: var(--color-text); }
    .btn--secondary:hover{ background: #E5E7EB; }
    .btn--outline{
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
    }
    .btn--outline:hover{ background: var(--color-muted); }
    .btn--lg{ font-size: 1.125rem; padding: 12px 20px; }
    .success-message{ margin-top:10px; color: var(--color-primary); font-weight: 500; }

    /* --- DATASET --- */
    .dataset-container{
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow);
      overflow-x: auto;
    }
    .table-container { min-width: 800px; }
    .table-container table{ width:100%; border-collapse: separate; border-spacing: 0; }
    .table-container th, .table-container td{
      padding: 12px;
      border-bottom: 1px solid var(--color-border);
      text-align: left;
      font-size: 0.875rem;
      vertical-align: middle;
    }
    .table-container thead th{
      position: sticky;
      top: 0;
      background: var(--color-surface);
      z-index: 1;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      font-size: 0.75rem;
    }
    .table-container .delete-btn{
      padding: 6px 10px;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background: transparent;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }
    .table-container .delete-btn:hover { background: var(--color-muted); color: #B91C1C; }
    .hidden{ display:none; }
    .header-actions{ display:flex; align-items:center; gap:10px; }

    /* --- EMPTY STATES --- */
    .empty-state{ display:grid; place-items:center; padding:40px 20px; color:var(--color-text-secondary); text-align:center; }
    .empty-icon{ font-size:42px; margin-bottom:8px; }

    /* --- TOOLTIP --- */
    .info-btn{
      width:20px; height:20px;
      border-radius: 50%;
      border: none;
      color: #fff;
      background: var(--color-text-secondary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.75rem;
      cursor: pointer;
      margin-left: 6px;
      vertical-align: middle;
    }
    .info-btn:hover{ background: var(--color-text); }
    .tooltip{
      position: absolute;
      background: #1F2937;
      color: #fff;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      max-width: 260px;
      font-size: 0.875rem;
      line-height: 1.5;
      box-shadow: var(--shadow-lg);
      transform: translate(-50%, -12px);
      pointer-events: none;
      z-index: 20;
    }
    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }

    /* --- TIMELINE --- */
    .timeline-container{
      display:grid;
      grid-template-columns: var(--legend-width) 1fr;
      gap:18px;
    }
    .timeline-legend, .timeline-visualization {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow);
    }
    .legend-section{ margin-bottom: 20px; }
    .legend-section h4 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; }
    .legend-items{ display:grid; grid-template-columns: 1fr; gap: 8px; }
    .legend-item{ display:flex; align-items:center; gap: 10px; font-size: 0.875rem; }
    .legend-swatch{ width:16px; height:16px; border-radius:var(--radius-sm); border:1px solid rgba(0,0,0,.08); }
    .legend-encoding{ list-style:none; margin: 8px 0 0; padding:0; display: flex; flex-direction: column; gap: 8px;}
    .legend-encoding li{ display:flex; align-items:center; gap:10px; font-size: 0.875rem; }
    .legend-encoding .symbol{
      display:inline-grid;
      place-items:center;
      width: 18px; 
      height: 18px;
      border-radius: var(--radius-md);
      color: var(--color-text, #1F2937);
      background-color: transparent;
      font-size: 12px; 
      font-weight: 700;
      border: 1.5px solid var(--color-border); 
    }
    .legend-gradient .gradient-bar{ height:12px; border-radius:999px; }
    .legend-gradient--neutral .gradient-bar{
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.4) 0%, rgba(79, 70, 229, 1.0) 100%);
    }
    .legend-ticks{ display:grid; grid-template-columns:repeat(5,1fr); margin-top:6px; font-size: 0.75rem; color: var(--color-text-secondary); }
    .legend-ticks span{ text-align:center; }
    .legend-ends{ display:flex; justify-content:space-between; color: var(--color-text-secondary); font-size: 0.875rem; margin-top: 4px; }
    .co2-scale{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap: 8px; 
      align-items:end;
      margin-top:10px;
    }
    .co2-bin{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .co2-block{
      width:100%;
      border-radius: var(--radius-sm);
      background: var(--color-primary); /* Use primary color */
      box-shadow: inset 0 -1px 0 rgba(255,255,255,.25);
    }
    .co2-label{ font-size: 0.75rem; color:var(--color-text-secondary); text-align:center; }
    #timeline-svg{
      width:100%;
      height:auto;
      overflow:visible;
      transform: scale(.975);
      transform-origin: center center;
    }
    .day-label{ font-size:11px; fill: var(--color-text); font-weight:500; text-anchor:middle; dominant-baseline:ideographic; }
    .time-label{ font-size:10px; fill: var(--color-text-secondary); text-anchor:middle; dominant-baseline:middle; }
    .ring-sep{ fill:none; stroke: var(--color-border); stroke-width:.8; opacity:.5; }
    .hour-line.regular{ stroke: var(--color-border); stroke-width:.6; stroke-opacity:.45; }
    .hour-line.midnight{ stroke: var(--color-border); stroke-width:.6; stroke-opacity:.25; }
    .legend-note{ color:var(--color-text-secondary); font-size: 0.875rem; margin-top:10px; }

    /* --- INSIGHTS --- */
    .insights-container-kix {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .filters-card{
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .filters-row{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; align-items: end; }
    .mode-checkboxes{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap: 6px; }
    .mode-check { display: flex; align-items: center; gap: 6px; font-size: 0.875rem; }
    .filter-actions { display: flex; gap: 8px; }
    .kix-kpi-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    .kpi-card-lg {
      display: flex;
      flex-direction: column;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 20px 24px;
      box-shadow: var(--shadow);
      transition: all 0.15s ease-in-out;
    }
    .kpi-card-lg .kpi-icon {
      font-size: 1.75rem;
      margin-bottom: 12px;
    }
    .kpi-card-lg .kpi-label {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
      margin-bottom: 4px;
    }
    .kpi-card-lg .kpi-value {
      font-size: 2rem;
      font-weight: 600;
      color: var(--color-text);
    }
    .insights-charts-grid-new {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .kix-card {
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow: hidden;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      transition: all 0.15s ease-in-out;
      height: 340px;
    }
    .kix-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    #co2-by-mode-chart,
    #co2-by-purpose-chart {
      cursor: pointer;
    }
    .kix-card h3{
      margin: 0 0 16px 0;
      flex: 0 0 auto;
    }
    .kix-card canvas, .kix-card .plotly-chart {
      display: block;
      width: 100%;
      height: 100% !important;  
      flex: 1 1 auto;
    }
    .kix-card-span-2 { 
      grid-column: span 2;
      height: 360px;
    }
    #dataset-empty,
    #timeline-empty,
    #insights-empty {
      display: none;
    }
    .view:has(> #timeline-content.hidden) ~ #timeline-empty {
      display: grid;
    }
    .view:has(> #insights-content.hidden) ~ #insights-empty {
      display: grid;
    }

    /* --- Responsive --- */
    @media (max-width: 768px) {
      .kix-kpi-row {
        grid-template-columns: repeat(2, 1fr);
      }
      .insights-charts-grid-new {
        grid-template-columns: 1fr;
      }
      .kix-card-span-2 {
        grid-column: span 1;
      }
    }
    @media (max-width:1000px){
      .form-grid{ grid-template-columns:repeat(2,1fr); }
      .g-col-span-2 { grid-column: span 2; }
      .timeline-container{ grid-template-columns:1fr; }
      .filters-row{ grid-template-columns:repeat(2,1fr); }
      .mode-checkboxes{ grid-template-columns:repeat(2,1fr); }
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      .g-col-span-2 { grid-column: span 1; }
      .filters-row{ grid-template-columns: 1fr; }
    }
    select.form-control{
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image:
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 18px;
      cursor: pointer;
    }
    select.form-control:disabled{
      color: #9CA3AF;
      background-color: var(--color-muted);
      cursor: not-allowed;
    }
    #modeDetailsGroup .form-control{ min-height: 44px; }
    #modeDetailsGroup select.form-control,
    #modeDetailsGroup input.form-control{ background-color: #F9FAFB; }
    #modeDetailsGroup .form-label{ margin-bottom: 4px; }
    input[type="number"].form-control,
    input[type="time"].form-control,
    input[type="date"].form-control{ min-height: 44px; }
    .filters-card,
    .insight-nav-tabs,
    .insight-dashboard {
      display: none;
    }
    .insight-dashboard.active {
      display: block;
    }
    .insights-container-kix {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .insights-charts-grid-new {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .kix-card {
      height: 420px;
    }
    .kix-card-span-2 { 
      grid-column: span 2;
      height: 420px;
    }
    .kix-card-span-3 {
      grid-column: span 2;
      height: 450px;
    }
    .kix-kpi-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
    }
    .kpi-card-lg {
      display: flex;
      flex-direction: column;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      transition: all 0.15s ease-in-out;
    }
    .kpi-card-lg:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    .kpi-card-lg .kpi-icon { font-size: 1.5rem; margin-bottom: 8px; }
    .kpi-card-lg .kpi-label { font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 4px; }
    .kpi-card-lg .kpi-value { font-size: 1.75rem; font-weight: 600; color: var(--color-text); }
    .kix-card-interactive canvas {
      cursor: pointer;
    }
    @media (max-width: 1100px) {
      .insights-charts-grid-new { grid-template-columns: 1fr; }
      .kix-card-span-2 { grid-column: span 1; }
      .kix-card-span-3 { grid-column: span 1; }
    }
    @media (max-width: 900px) {
      .kix-kpi-row { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .kix-kpi-row { grid-template-columns: 1fr; }
    }
  </style>

  <script src="https://cdn.plot.ly/plotly-latest.min.js" defer></script>
  </head>
<body>
  <div class="app-container">
  
    <nav class="main-nav">
  <div class="nav-brand">
    <h1>Trip Tracker</h1>
    <p>Sustainable Mobility Dashboard</p>
  </div>

  <div class="nav-links" role="tablist" aria-label="Primary views">
    <button type="button" class="nav-btn" data-view="entry"
            role="tab" aria-controls="entry-view" aria-selected="false">
      Trip Entry
    </button>
    <button type="button" class="nav-btn" data-view="dataset"
            role="tab" aria-controls="dataset-view" aria-selected="false">
      Dataset
    </button>
    <button type="button" class="nav-btn" data-view="timeline"
            role="tab" aria-controls="timeline-view" aria-selected="false">
      Timeline
    </button>
    <button type="button" class="nav-btn" data-view="insights"
            role="tab" aria-controls="insights-view" aria-selected="false">
      Insights
    </button>
  </div>
</nav>

    <main class="main-content">
      <section id="entry-view" class="view">
        <div class="page-header">
          <h2>Add New Trip</h2>
        </div>

        <form id="trip-form" class="trip-form">
          <div class="form-section">
            <h3>Trip Characteristics</h3>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" id="date" class="form-control" required>
              </div>

              <div class="form-group">
                <label class="form-label">Trip Type</label>
                <select id="tripType" class="form-control">
                  <option value="Commute">Commute</option>
                  <option value="Study">Study</option>
                  <option value="Leisure">Leisure</option>
                  <option value="Work">Work</option>
                  <option value="Errands">Errands</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="form-group g-col-span-2">
                <label class="form-label">Origin *</label>
                <input type="text" id="origin" class="form-control" placeholder="Starting point" required>
              </div>

              <div class="form-group g-col-span-2">
                <label class="form-label">Destination *</label>
                <input type="text" id="destination" class="form-control" placeholder="End point" required>
              </div>

              <div class="form-group">
                <label class="form-label">Distance (km) *</label>
                <input type="number" id="distance" class="form-control" step="0.1" min="0" placeholder="0.0" required>
              </div>

              <div class="form-group">
                <label class="form-label">Transport Mode *</label>
                <select id="mode" class="form-control" required>
                  <option value="">Select mode</option>
                  <option value="Car_driver">Car (Driver)</option>
                  <option value="Car_passenger">Car (Passenger)</option>
                  <option value="Metro">Metro</option>
                  <option value="Bus">Bus</option>
                  <option value="Tram">Tram</option>
                  <option value="Walking">Walking</option>
                  <option value="Bike">Bike</option>
                </select>
              </div>

              <div class="form-group g-col-span-2" id="modeDetailsGroup" style="display:none">
                <label id="modeDetailsLabel" class="form-label">Details</label>
                <select id="modeDetailsSelect" class="form-control" style="display:none">
                  <option value="">Vehicle type</option>
                  <option value="Petrol Euro 6">Petrol Euro 6</option>
                  <option value="Petrol Euro 5">Petrol Euro 5</option>
                  <option value="Diesel Euro 6">Diesel Euro 6</option>
                  <option value="Hybrid">Hybrid</option>
                  <option value="Electric">Electric</option>
                </select>
                <input type="number" id="modeDetailsNumber" class="form-control" min="2" placeholder="Total passengers" style="display:none">
                <input type="text" id="modeDetailsText" class="form-control" placeholder="Line number/name" style="display:none">
              </div>

              <div class="form-group g-col-span-2">
                <label class="form-label">Departure Time *</label>
                <input type="time" id="departureTime" class="form-control" required>
              </div>

              <div class="form-group g-col-span-2">
                <label class="form-label">Arrival Time *</label>
                <input type="time" id="arrivalTime" class="form-control" required>
              </div>
              
            </div>
          </div>

          <div class="form-section">
            <h3>Context</h3>

            <div class="form-grid">
              <div class="form-group full">
                <label class="form-label">Stress Level: <span id="stressValue">3</span>/5</label>
                <div class="stress-slider-container">
                  <span class="stress-label">üòå Low</span>
                  <input type="range" id="stress" min="1" max="5" value="3" step="1" class="stress-slider">
                  <span class="stress-label">üò∞ High</span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-section calculated-preview" id="calculatedPreview" style="display:none">
            <h3>Calculated Values</h3>
            <div class="calc-grid">
              <div class="calc-item">
                <span class="calc-label">Actual Duration</span>
                <span class="calc-value" id="previewDuration">-</span>
              </div>
              <div class="calc-item">
                <span class="calc-label">
                  CO‚ÇÇ Emissions
                  <button type="button" class="info-btn" data-tooltip="co2">?</button>
                </span>
                <span class="calc-value" id="previewCO2">-</span>
              </div>
              <div class="calc-item">
                <span class="calc-label">
                  Sustainability Score
                  <button type="button" class="info-btn" data-tooltip="sustainability">?</button>
                </span>
                <span class="calc-value" id="previewScore">-</span>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn--primary btn--lg">Save Trip</button>
            <button type="button" id="reset-form" class="btn btn--secondary btn--lg">Reset</button>
          </div>
        </form>

        <div id="success-message" class="success-message hidden">
          ‚úì Trip saved successfully!
        </div>
      </section>

      <section id="dataset-view" class="view">
        <div class="page-header">
          <h2>Trip Dataset</h2>
          <div class="header-actions">
            <span>Total Trips: <strong id="tripCount">0</strong></span>
            <button id="exportBtn" class="btn btn--secondary">Export CSV</button>
            <button id="clear-data-btn" class="btn btn--outline">Clear All Data</button>
          </div>
        </div>

        <div class="dataset-container">
          <div id="dataset-table-container" class="table-container"></div>
        </div>
      </section>

      <section id="timeline-view" class="view">
        <div class="page-header">
          <h2>Weekly Radial Timeline</h2>
        </div>

        <div id="timeline-content" class="timeline-container hidden">
          <aside class="timeline-legend" aria-labelledby="legend-title">
            <h3 id="legend-title">Legend</h3>

            <div class="legend-section">
              <h4>Transport modes</h4>
              <div id="legend-modes" class="legend-items"></div>
            </div>

            <div class="legend-section">
              <h4>Trip purpose</h4>
              <ul id="legend-purpose" class="legend-encoding"></ul>
            </div>

            <div class="legend-section">
              <h4>Stress level</h4>
              <div class="legend-gradient legend-gradient--neutral" aria-hidden="true">
                <div class="gradient-bar"></div>
              </div>
              <div class="legend-ticks">
                <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
              </div>
              <div class="legend-ends">
                <span>Low</span><span>High</span>
              </div>
            </div>

            <div class="legend-section">
              <h4>CO‚ÇÇ emissions</h4>
              <div id="legend-co2" class="co2-scale"></div>
              <p class="legend-note">Cell <strong>thickness</strong> &prop; CO‚ÇÇ (kg) per trip.</p>
            </div>
          </aside>

          <div class="timeline-visualization">
            <svg id="timeline-svg"
                 viewBox="0 0 800 800"
                 preserveAspectRatio="xMidYMid meet"
                 role="img"
                 aria-label="Weekly radial timeline, days as rings, hours as segments"></svg>
          </div>
        </div>
      </section>

    <section id="insights-view" class="view">
      <div class="page-header">
        <h2>Insights & Analytics</h2>
        <button id="clear-cross-filters" class="btn btn--outline" style="display: none;">
          Reset Selection
        </button>
      </div>

      <div id="insights-content" class="insights-container-kix hidden">
        
        <div class="kix-kpi-row">
          <div class="kpi-card-lg">
            <span class="kpi-icon">#Ô∏è‚É£</span> <span class="kpi-label">Total Trips</span>
            <span class="kpi-value" id="kix-kpi-trips">0</span>
          </div>
          <div class="kpi-card-lg">
            <span class="kpi-icon">üí®</span> <span class="kpi-label">Total CO‚ÇÇ</span>
            <span class="kpi-value" id="kix-kpi-co2">0 kg</span>
          </div>
          <div class="kpi-card-lg">
            <span class="kpi-icon">üò∞</span> <span class="kpi-label">Average Stress</span>
            <span class="kpi-value" id="kix-kpi-stress">0 / 5</span>
          </div>
          <div class="kpi-card-lg">
            <span class="kpi-icon">‚ö°Ô∏è</span> <span class="kpi-label">Average Efficiency</span>
            <span class="kpi-value" id="kix-kpi-gkm">0 g/km</span>
          </div>
          <div class="kpi-card-lg">
            <span class="kpi-icon">üåø</span> <span class="kpi-label">Sustainability Score</span>
            <span class="kpi-value" id="kix-kpi-score">0</span>
          </div>
        </div>
<div class="insights-charts-grid-new">

          <div class="kix-card kix-card-interactive">
            <h3 id="co2-day-title">Total CO‚ÇÇ Emissions by Day</h3>
            <div id="co2-by-day-chart" class="plotly-chart"></div>
          </div>
          <div class="kix-card kix-card-interactive">
            <h3 id="co2-pie-title">CO‚ÇÇ Share by Mode</h3>
            <div id="co2-pie-chart" class="plotly-chart"></div>
          </div>

          <div class="kix-card kix-card-span-2 kix-card-interactive">
            <h3 id="heatmap-title">Average Stress by Day & Time Slot</h3>
            <div id="stress-heatmap-chart" class="plotly-chart"></div>
          </div>

          <div class="kix-card kix-card-interactive">
            <h3 id="stress-mode-title">Average Stress by Mode</h3>
            <div id="stress-by-mode-chart" class="plotly-chart"></div>
          </div>
          <div class="kix-card kix-card-interactive">
            <h3 id="stress-purpose-title">Average Stress by Purpose</h3>
            <div id="stress-by-purpose-chart" class="plotly-chart"></div>
          </div>

          <div class="kix-card kix-card-span-2"> <h3 id="efficiency-stress-title">Efficiency vs Stress</h3>
            <div id="efficiency-stress-chart" class="plotly-chart"></div>
          </div>

        </div>
      </div>
      
      <div id="insights-empty" class="empty-state">
        <div>
          <div class="empty-icon">üìä</div>
          <h3>Not Enough Data for Analysis</h3>
          <p>Add at least 3 trips to unlock the 'Insights' section.</p>
        </div>
      </div>
    </section>

    </main>
  </div>

  <div id="tooltips" class="sr-only"
       data-co2="CO‚ÇÇ = Distance √ó factor(mode). e.g.: Car_driver 0.192 kg/km; Metro 0.041; Bus 0.105; Tram 0.035; Walking/Bike 0."
       data-sustainability="Score = 100 ‚àí min(60, 100√óCO‚ÇÇ/km) ‚àí 5√óStress. Clamped 0‚Äì100.">
  </div>

  <script>
    // =============== PERSISTENCE =================
    const STORAGE_KEY = 'tripTracker_trips_v2';
    const PRELOADED_TRIPS = [
    {"date":"2025-10-27","origin":"Eur Magliana","destination":"Policlinico","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"07:18","arrivalTime":"07:41","tripType":"Study","stressLevel":5,"duration":23,"co2":0.369},
    {"date":"2025-10-27","origin":"Policlinico","destination":"University","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"3BUS","departureTime":"08:02","arrivalTime":"08:14","tripType":"Study","stressLevel":4,"duration":12,"co2":0.199},
    {"date":"2025-10-27","origin":"University","destination":"Policlinico","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"19NAV","departureTime":"13:45","arrivalTime":"13:58","tripType":"Study","stressLevel":2,"duration":13,"co2":0.199},
    {"date":"2025-10-27","origin":"Policlinico","destination":"Eur Magliana","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"14:10","arrivalTime":"14:35","tripType":"Study","stressLevel":2,"duration":25,"co2":0.369},
    {"date":"2025-10-27","origin":"Eur Magliana","destination":"Policlinico","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"16:05","arrivalTime":"16:30","tripType":"Study","stressLevel":3,"duration":25,"co2":0.369},
    {"date":"2025-10-27","origin":"Policlinico","destination":"University","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"3BUS","departureTime":"17:00","arrivalTime":"17:13","tripType":"Study","stressLevel":3,"duration":13,"co2":0.199},
    {"date":"2025-10-27","origin":"University","destination":"Policlinico","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"19NAV","departureTime":"18:50","arrivalTime":"19:05","tripType":"Study","stressLevel":4,"duration":15,"co2":0.199},
    {"date":"2025-10-27","origin":"Policlinico","destination":"Eur Magliana","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"19:15","arrivalTime":"19:40","tripType":"Study","stressLevel":4,"duration":25,"co2":0.369},
    {"date":"2025-10-28","origin":"Eur Magliana","destination":"Policlinico","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"08:55","arrivalTime":"09:18","tripType":"Study","stressLevel":5,"duration":23,"co2":0.369},
    {"date":"2025-10-28","origin":"Policlinico","destination":"University","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"3BUS","departureTime":"09:30","arrivalTime":"09:43","tripType":"Study","stressLevel":4,"duration":13,"co2":0.199},
    {"date":"2025-10-28","origin":"University","destination":"Policlinico","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"19NAV","departureTime":"13:40","arrivalTime":"13:54","tripType":"Study","stressLevel":2,"duration":14,"co2":0.199},
    {"date":"2025-10-28","origin":"Policlinico","destination":"Eur Magliana","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"14:05","arrivalTime":"14:28","tripType":"Study","stressLevel":2,"duration":23,"co2":0.369},
    {"date":"2025-10-28","origin":"Pazzamente pizza 2","destination":"Viale Beata Vergine del Carmelo","distance":2.6,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"19:05","arrivalTime":"19:11","tripType":"Work","stressLevel":2,"duration":6,"co2":0.499},
    {"date":"2025-10-28","origin":"Viale Beata Vergine del Carmelo","destination":"Pazzamente pizza 2","distance":3,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"19:35","arrivalTime":"19:39","tripType":"Work","stressLevel":1,"duration":4,"co2":0.576},
    {"date":"2025-10-28","origin":"Pazzamente pizza 2","destination":"Via Cina","distance":2,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:05","arrivalTime":"20:08","tripType":"Work","stressLevel":3,"duration":3,"co2":0.384},
    {"date":"2025-10-28","origin":"Via Cina","destination":"Pazzamente pizza 2","distance":2.7,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:25","arrivalTime":"20:29","tripType":"Work","stressLevel":2,"duration":4,"co2":0.518},
    {"date":"2025-10-28","origin":"Pazzamente pizza 2","destination":"Via Domenico Giuliotti","distance":4.1,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"21:05","arrivalTime":"21:12","tripType":"Work","stressLevel":1,"duration":7,"co2":0.787},
    {"date":"2025-10-28","origin":"Via Domenico Giuliotti","destination":"Pazzamente pizza 2","distance":4,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"21:25","arrivalTime":"21:30","tripType":"Work","stressLevel":3,"duration":5,"co2":0.768},
    {"date":"2025-10-29","origin":"Eur Magliana","destination":"Policlinico","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"08:50","arrivalTime":"09:15","tripType":"Study","stressLevel":5,"duration":25,"co2":0.369},
    {"date":"2025-10-29","origin":"Policlinico","destination":"University","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"3BUS","departureTime":"09:25","arrivalTime":"09:39","tripType":"Study","stressLevel":4,"duration":14,"co2":0.199},
    {"date":"2025-10-29","origin":"University","destination":"Policlinico","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"19NAV","departureTime":"11:50","arrivalTime":"12:05","tripType":"Study","stressLevel":2,"duration":15,"co2":0.199},
    {"date":"2025-10-29","origin":"Policlinico","destination":"Eur Magliana","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"12:15","arrivalTime":"12:40","tripType":"Study","stressLevel":2,"duration":25,"co2":0.369},
    {"date":"2025-10-29","origin":"Home","destination":"Molly's - Via Gaetano Butera","distance":4.7,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:25","arrivalTime":"20:35","tripType":"Leisure","stressLevel":3,"duration":10,"co2":0.902},
    {"date":"2025-10-29","origin":"Molly's - Via Gaetano Butera","destination":"Home","distance":6,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"23:20","arrivalTime":"23:30","tripType":"Leisure","stressLevel":2,"duration":10,"co2":1.152},
    {"date":"2025-10-30","origin":"Eur Magliana","destination":"Policlinico","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"10:30","arrivalTime":"10:55","tripType":"Study","stressLevel":3,"duration":25,"co2":0.369},
    {"date":"2025-10-30","origin":"Policlinico","destination":"University","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"3BUS","departureTime":"11:10","arrivalTime":"11:23","tripType":"Study","stressLevel":2,"duration":13,"co2":0.199},
    {"date":"2025-10-30","origin":"University","destination":"Policlinico","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"19NAV","departureTime":"13:40","arrivalTime":"13:55","tripType":"Study","stressLevel":2,"duration":15,"co2":0.199},
    {"date":"2025-10-30","origin":"Policlinico","destination":"Eur Magliana","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"14:05","arrivalTime":"14:30","tripType":"Study","stressLevel":2,"duration":25,"co2":0.369},
    {"date":"2025-10-30","origin":"Home","destination":"Viale Gianluigi Bonelli","distance":4.9,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":2,"line":"","departureTime":"16:30","arrivalTime":"16:38","tripType":"Errands","stressLevel":3,"duration":8,"co2":0.47},
    {"date":"2025-10-30","origin":"Viale Gianluigi Bonelli","destination":"Home","distance":5.2,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":2,"line":"","departureTime":"17:05","arrivalTime":"17:15","tripType":"Errands","stressLevel":2,"duration":10,"co2":0.499},
    {"date":"2025-10-31","origin":"Home","destination":"Elite Supermarket","distance":1.8,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":2,"line":"","departureTime":"10:20","arrivalTime":"10:25","tripType":"Errands","stressLevel":2,"duration":5,"co2":0.173},
    {"date":"2025-10-31","origin":"Elite Supermarket","destination":"Home","distance":2.4,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":2,"line":"","departureTime":"10:40","arrivalTime":"10:45","tripType":"Errands","stressLevel":2,"duration":5,"co2":0.23},
    {"date":"2025-10-31","origin":"Eur Magliana","destination":"Policlinico","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"14:20","arrivalTime":"14:43","tripType":"Study","stressLevel":2,"duration":23,"co2":0.369},
    {"date":"2025-10-31","origin":"Policlinico","destination":"University","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"3BUS","departureTime":"15:00","arrivalTime":"15:14","tripType":"Study","stressLevel":3,"duration":14,"co2":0.199},
    {"date":"2025-10-31","origin":"University","destination":"Policlinico","distance":1.9,"mode":"Bus","vehicle":"","passengers":"","line":"19NAV","departureTime":"17:20","arrivalTime":"17:35","tripType":"Study","stressLevel":3,"duration":15,"co2":0.199},
    {"date":"2025-10-31","origin":"Policlinico","destination":"Eur Magliana","distance":9,"mode":"Metro","vehicle":"","passengers":"","line":"Metro B","departureTime":"18:00","arrivalTime":"18:25","tripType":"Study","stressLevel":4,"duration":25,"co2":0.369},
    {"date":"2025-10-31","origin":"Pazzamente pizza 2","destination":"Via dell'Orsa Minore","distance":1.5,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"19:30","arrivalTime":"19:33","tripType":"Work","stressLevel":1,"duration":3,"co2":0.288},
    {"date":"2025-10-31","origin":"Via dell'Orsa Minore","destination":"Pazzamente pizza 2","distance":1.9,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"19:45","arrivalTime":"19:49","tripType":"Work","stressLevel":2,"duration":4,"co2":0.365},
    {"date":"2025-10-31","origin":"Pazzamente pizza 2","destination":"Via Mario Mona","distance":1.7,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:10","arrivalTime":"20:13","tripType":"Work","stressLevel":3,"duration":3,"co2":0.326},
    {"date":"2025-10-31","origin":"Via Mario Mona","destination":"Pazzamente pizza 2","distance":2.6,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:30","arrivalTime":"20:35","tripType":"Work","stressLevel":1,"duration":5,"co2":0.499},
    {"date":"2025-10-31","origin":"Pazzamente pizza 2","destination":"Via Ildebrando Vivanti","distance":2.9,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"21:00","arrivalTime":"21:04","tripType":"Work","stressLevel":2,"duration":4,"co2":0.557},
    {"date":"2025-10-31","origin":"Via Ildebrando Vivanti","destination":"Pazzamente pizza 2","distance":3.3,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"21:20","arrivalTime":"21:25","tripType":"Work","stressLevel":3,"duration":5,"co2":0.634},
    {"date":"2025-11-01","origin":"Home","destination":"Viale Europa","distance":2.9,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":2,"line":"","departureTime":"11:00","arrivalTime":"11:05","tripType":"Leisure","stressLevel":1,"duration":5,"co2":0.278},
    {"date":"2025-11-01","origin":"Viale Europa","destination":"Home","distance":2.7,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":2,"line":"","departureTime":"13:35","arrivalTime":"13:40","tripType":"Leisure","stressLevel":1,"duration":5,"co2":0.259},
    {"date":"2025-11-01","origin":"Home","destination":"The Space - Parco de' Medici","distance":8.3,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"21:00","arrivalTime":"21:10","tripType":"Leisure","stressLevel":2,"duration":10,"co2":1.594},
    {"date":"2025-11-02","origin":"The Space - Parco de' Medici","destination":"Home","distance":10,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"00:20","arrivalTime":"00:30","tripType":"Leisure","stressLevel":2,"duration":10,"co2":1.92},
    {"date":"2025-11-02","origin":"Home","destination":"Maximo Shopping Center","distance":4.9,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":2,"line":"","departureTime":"10:00","arrivalTime":"10:07","tripType":"Leisure","stressLevel":1,"duration":7,"co2":0.47},
    {"date":"2025-11-02","origin":"Maximo Shopping Center","destination":"Home","distance":5.5,"mode":"Car_passenger","vehicle":"Petrol Euro 5","passengers":3,"line":"","departureTime":"13:30","arrivalTime":"13:37","tripType":"Leisure","stressLevel":1,"duration":7,"co2":0.528},
    {"date":"2025-11-02","origin":"Pazzamente pizza 2","destination":"Via Amsterdam","distance":1.7,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"19:15","arrivalTime":"19:17","tripType":"Work","stressLevel":2,"duration":2,"co2":0.326},
    {"date":"2025-11-02","origin":"Via Amsterdam","destination":"Pazzamente pizza 2","distance":1.3,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"19:30","arrivalTime":"19:33","tripType":"Work","stressLevel":1,"duration":3,"co2":0.25},
    {"date":"2025-11-02","origin":"Pazzamente pizza 2","destination":"Via Copenaghen","distance":1.3,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"19:45","arrivalTime":"19:49","tripType":"Work","stressLevel":3,"duration":4,"co2":0.25},
    {"date":"2025-11-02","origin":"Via Copenaghen","destination":"Pazzamente pizza 2","distance":1,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:05","arrivalTime":"20:07","tripType":"Work","stressLevel":2,"duration":2,"co2":0.192},
    {"date":"2025-11-02","origin":"Pazzamente pizza 2","destination":"Via Tolosa","distance":1,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:25","arrivalTime":"20:28","tripType":"Work","stressLevel":1,"duration":3,"co2":0.192},
    {"date":"2025-11-02","origin":"Via Tolosa","destination":"Pazzamente pizza 2","distance":1,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"20:45","arrivalTime":"20:47","tripType":"Work","stressLevel":1,"duration":2,"co2":0.192},
    {"date":"2025-11-02","origin":"Pazzamente pizza 2","destination":"Viale Don Pasquino Borghi","distance":1.9,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"21:05","arrivalTime":"21:10","tripType":"Work","stressLevel":3,"duration":5,"co2":0.365},
    {"date":"2025-11-02","origin":"Viale Don Pasquino Borghi","destination":"Pazzamente pizza 2","distance":1.3,"mode":"Car_driver","vehicle":"Petrol Euro 5","passengers":"","line":"","departureTime":"21:20","arrivalTime":"21:23","tripType":"Work","stressLevel":2,"duration":3,"co2":0.25}
    ];
    function storageOK(){
      try{ localStorage.setItem('__t','t'); localStorage.removeItem('__t'); return true; }
      catch(e){ alert('localStorage is not available (private browsing mode?)'); return false; }
    }

    function loadTrips(){
      if(!storageOK()) return PRELOADED_TRIPS;
      const localData = localStorage.getItem(STORAGE_KEY);
      if (localData === null) {
        saveTrips(PRELOADED_TRIPS);
        return PRELOADED_TRIPS;
      }
      try{ 
        return JSON.parse(localData);
      }
      catch(e){ 
        console.warn('Corrupted local data, loading preloaded trips.'); 
        return PRELOADED_TRIPS; 
      }
    }
    function saveTrips(trips){
      if(!storageOK()) return;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(trips));
    }
    let trips = loadTrips();

    // =============== CONSTANTS / CO2 FACTORS =================
    const ALL_MODES = ['Car_driver','Car_passenger','Metro','Bus'];
    const MODE_COLORS = {
      Car_driver:'#ef4444', Car_passenger:'#fb923c',
      Metro:'#3b82f6', Bus:'#06b6d4', Tram:'#16a34a',
      Walking:'#10b981', Bike:'#84cc16'
    };
    const VISIBLE_MODES = ['Car_driver','Car_passenger','Metro','Bus'];
    const CO2_FACTORS = {
      Car_driver:0.192, Car_passenger:0.096,
      Metro:0.041, Bus:0.105, Tram:0.035, Walking:0, Bike:0
    };
    const PURPOSE_COLORS = {
      Commute: '#22c55e', Study: '#3b82f6', Leisure: '#ec4899',
      Work: '#f59e0b', Errands: '#8b5cf6', Other: '#6b7280'
    };
    const FALLBACK_COLOR = '#9ca3af';

    // =============== UTILITIES =================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function minutesBetween(h1, h2){
      if(!h1||!h2) return 0;
      const [a,b]=h1.split(':').map(Number), [c,d]=h2.split(':').map(Number);
      let s=a*60+b, e=c*60+d; if(e<s) e+=1440; return e-s;
    }
    function computeCO2(mode, km){
      const f = CO2_FACTORS[mode] ?? 0; return +(km*f).toFixed(3);
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

    // =============== NAV =================
    const VIEW_KEYS = ['entry','dataset','timeline','insights'];

    function switchView(target){
      if(!VIEW_KEYS.includes(target)) target = 'entry';

      $$('.view').forEach(v => v.classList.remove('active'));
      const section = document.getElementById(`${target}-view`);
      if (section) section.classList.add('active');
      
      $$('.nav-btn').forEach(b => {
        const active = b.dataset.view === target;
        b.classList.toggle('active', active);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });

      renderEmptyStates();
      
      if (target === 'dataset') {
        if (typeof renderDataset === 'function') renderDataset();
      } else if (target === 'timeline') {
        if (typeof renderTimeline === 'function') {
          try { renderTimeline(); } catch (e) { console.error('[Timeline] crash:', e); }
        }
      } else if (target === 'insights') {
        if (typeof initFilters === 'function')  initFilters(trips);
        if (typeof renderInsights === 'function' && trips.length >= 3) {
            renderInsights(trips);
        }
      }

      if (location.hash !== `#${target}`) {
        history.replaceState({}, '', `#${target}`);
      }
    }

    function initNav(){
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.nav-btn');
        if (!btn) return;
        const key = btn.dataset.view;
        if (!key) return;
        e.preventDefault();
        switchView(key);
      });
      const initial = (location.hash || '').replace('#','');
      switchView(VIEW_KEYS.includes(initial) ? initial : 'entry');
    }

    // =============== ENTRY FORM =================
    function initEntryForm(){
      const form = $('#trip-form');
      const stress = $('#stress');
      const stressValue = $('#stressValue');
      const modeSel = $('#mode');
      const detailsGroup = $('#modeDetailsGroup');
      const selectVehicle = $('#modeDetailsSelect');
      const inputPassengers = $('#modeDetailsNumber');
      const inputLine = $('#modeDetailsText');
      const departure = $('#departureTime');
      const arrival = $('#arrivalTime');
      const distance = $('#distance');
      if(stress) stress.addEventListener('input', ()=>{ stressValue.textContent = stress.value; });
      function updateModeDetails(){
        const m = modeSel.value;
        detailsGroup.style.display = m ? 'block' : 'none';
        selectVehicle.style.display = (m.startsWith('Car')) ? 'block' : 'none';
        inputPassengers.style.display = (m==='Car_passenger') ? 'block' : 'none';
        inputLine.style.display = (m==='Metro' || m==='Bus' || m==='Tram') ? 'block' : 'none';
      }
      modeSel.addEventListener('change', updateModeDetails); updateModeDetails();
      const pv = {
        wrap: $('#calculatedPreview'),
        dur: $('#previewDuration'),
        co2: $('#previewCO2'),
        score: $('#previewScore')
      };
      function recomputePreview(){
        const dur = minutesBetween(departure.value, arrival.value);
        const km = parseFloat(distance.value||'0')||0;
        const co2 = computeCO2(modeSel.value, km);
        const stressVal = +($('#stress')?.value||3);
        const score = clamp(100 - Math.min(60, 100*(km?co2/km:0)) - 5*stressVal, 0, 100);
        if(dur||co2||km){
          pv.wrap.style.display = 'block';
          pv.dur.textContent = `${dur} min`;
          pv.co2.textContent = `${co2.toFixed(3)} kg`;
          pv.score.textContent = `${score.toFixed(0)}`;
        } else {
          pv.wrap.style.display = 'none';
        }
      }
      [departure, arrival, distance, modeSel, stress].forEach(el=>el && el.addEventListener('input',recomputePreview));
      recomputePreview();
      document.body.addEventListener('click', (e)=>{
        if(e.target.matches('.info-btn')){
          const key = e.target.dataset.tooltip;
          const root = $('#tooltips');
          const text = root?.dataset[key] || '‚Äî';
          let tip = document.createElement('div');
          tip.className = 'tooltip';
          tip.textContent = text;
          document.body.appendChild(tip);
          const rect = e.target.getBoundingClientRect();
          tip.style.left = `${rect.left + rect.width/2}px`;
          tip.style.top = `${rect.top + window.scrollY - 8}px`;
          setTimeout(()=> tip.remove(), 2600);
        }
      });
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const record = {
        date: $('#date').value,
        origin: $('#origin').value,
        destination: $('#destination').value,
        distance: +(parseFloat($('#distance').value || '0').toFixed(2)),
        mode: $('#mode').value,
        vehicle: selectVehicle.style.display === 'block' ? selectVehicle.value : '',
        passengers: inputPassengers.style.display === 'block' ? +inputPassengers.value || '' : '',
        line: inputLine.style.display === 'block' ? inputLine.value : '',
        departureTime: $('#departureTime').value,
        arrivalTime: $('#arrivalTime').value,
        tripType: $('#tripType').value,
        stressLevel: +($('#stress').value || 3),
      };
      record.duration = minutesBetween(record.departureTime, record.arrivalTime);
      record.co2 = computeCO2(record.mode, record.distance);
      trips.push(record);
      trips.sort((a, b) => {
        const dateA = new Date(a.date + 'T' + a.departureTime);
        const dateB = new Date(b.date + 'T' + b.departureTime);
        return dateA - dateB;
      });
      saveTrips(trips);
      $('#success-message').classList.remove('hidden');
      setTimeout(()=>$('#success-message').classList.add('hidden'), 1200);
      form.reset();
      updateModeDetails();
      recomputePreview();
      renderDataset();
      renderEmptyStates();
      if (typeof renderInsights === 'function' && trips.length >= 3) {
        renderInsights(trips);
      }
    });
      $('#reset-form').addEventListener('click', ()=>{ form.reset(); updateModeDetails(); recomputePreview(); });
    }

    // =============== DATASET =================
    const datasetTable = $('#dataset-table-container');
    function renderDataset(){
      const tripCountEl = $('#tripCount');
      if (tripCountEl) tripCountEl.textContent = String(trips.length);
      const headers = [
        'Date','Route','Distance (km)','Mode + Details',
        'Duration (min)',
        'CO‚ÇÇ (kg) <button type="button" class="info-btn" data-tooltip="co2">?</button>',
        'Score <button type="button" class="info-btn" data-tooltip="sustainability">?</button>',
        'Type','Stress','Actions'
      ];
      if (!trips.length){
        datasetTable.innerHTML = `
          <table>
            <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
            <tbody>
              <tr>
                <td colspan="${headers.length}" style="text-align:center; opacity:.7; padding:16px;">
                  No trips recorded yet ‚Äî add your first trip to populate the table.
                </td>
              </tr>
            </tbody>
          </table>
        `;
        return;
      }
      const rows = trips.map((t,i)=>{
        const md = [
          t.mode,
          t.vehicle ? `‚Ä¢ ${t.vehicle}` : '',
          t.passengers ? `‚Ä¢ pax: ${t.passengers}` : '',
          t.line ? `‚Ä¢ ${t.line}` : ''
        ].filter(Boolean).join(' ');
        const act = t.duration ?? '';
        const km  = (typeof t.distance === 'number') ? t.distance.toFixed(2) : (t.distance ?? '');
        const co2 = (typeof t.co2 === 'number') ? t.co2.toFixed(3) : (t.co2 ?? '');
        return `
          <tr>
            <td>${t.date || ''}</td>
            <td>${(t.origin || '')} ‚Üí ${(t.destination || '')}</td>
            <td>${km}</td>
            <td>${md}</td>
            <td>${act} min</td> <td>${co2}</td>
            <td>${computeScore(t).toFixed(0)}</td>
            <td>${t.tripType || ''}</td>
            <td>${t.stressLevel ?? ''}</td>
            <td><button class="delete-btn" data-index="${i}">Delete</button></td>
          </tr>
        `;
      }).join('');
      datasetTable.innerHTML = `
        <table>
          <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
    datasetTable.addEventListener('click', (e)=>{
      const btn = e.target.closest('.delete-btn');
      if (!btn) return;
      const idx = +btn.dataset.index;
      if (Number.isInteger(idx)) {
        trips.splice(idx, 1);
        saveTrips(trips);
        renderDataset();
        renderEmptyStates();
        if (typeof renderInsights === 'function') {
          renderInsights(trips);
        }
      }
    });
    $('#exportBtn')?.addEventListener('click', ()=>{
      const cols = [
        'date','origin','destination','distance','mode','vehicle','passengers','line',
        'departureTime','arrivalTime','duration','co2','tripType','stressLevel'
      ];
      const headerLabels = [
        'Date','Origin','Destination','Distance_km','Mode','Vehicle','Passengers','Line',
        'Departure','Arrival','Actual_min','CO2_kg','Type','Stress' 
      ];
      const rows = trips.map(t => cols.map(k => {
        const v = t[k] ?? '';
        if (k === 'distance' && typeof v === 'number') return v.toFixed(2);
        if (k === 'co2'      && typeof v === 'number') return v.toFixed(3);
        return String(v);
      }));
      const csv = [headerLabels, ...rows]
        .map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(','))
        .join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'trips.csv';
      a.click();
    });
    $('#clear-data-btn')?.addEventListener('click', ()=>{
      if(!confirm('Delete all locally saved data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      trips = [];
      renderDataset();
      renderEmptyStates();
      if (typeof renderInsights === 'function') {
        renderInsights(trips);
      }
    });
    function computeScore(t){
      const co2perKm = (t.distance > 0) ? (t.co2 / t.distance) : 0;
      return clamp(100 - Math.min(60, 100 * co2perKm) - 5 * (t.stressLevel || 3), 0, 100);
    }

    // =============== EMPTY STATES =================
    function renderEmptyStates() {
      const hasTrips   = Array.isArray(trips) && trips.length > 0;
      const enoughData = trips.length >= 3; 
      const tEmpty  = $('#timeline-empty');
      const tContent = $('#timeline-content');
      if (tEmpty && tContent) {
        tEmpty.style.display = hasTrips ? 'none' : 'grid';
        tContent.classList.toggle('hidden', !hasTrips);
      }
      const iEmpty  = $('#insights-empty');
      const iContent = $('#insights-content');
      if (iEmpty && iContent) {
        iEmpty.style.display = enoughData ? 'none' : 'grid';
        iContent.classList.toggle('hidden', !enoughData);
      }
    }

    // =============== TIMELINE ===============
    function drawArc(trip, a1, a2, rInner, rOuter, maxCO2, gCells, cx, cy, ringW) {
      if (!trip) return;
      const fill = (typeof MODE_COLORS !== 'undefined' && MODE_COLORS[trip.mode]) ? MODE_COLORS[trip.mode] : '#9CA3AF';
      const co2 = +trip.co2 || 0;
      const stress = clamp(+trip.stressLevel || 3, 1, 5);
      const frac = Math.max(0.2, Math.sqrt(co2 / maxCO2)); 
      const cellH = ringW * 0.8 * frac;
      const inR = rInner + (ringW - cellH) / 2;
      const outR = inR + cellH;
      const arcPath = (cx, cy, r1, r2, a1, a2) => {
        const x1 = cx + r1 * Math.cos(a1), y1 = cy + r1 * Math.sin(a1);
        const x2 = cx + r2 * Math.cos(a1), y2 = cy + r2 * Math.sin(a1);
        const x3 = cx + r2 * Math.cos(a2), y3 = cy + r2 * Math.sin(a2);
        const x4 = cx + r1 * Math.cos(a2), y4 = cy + r1 * Math.sin(a2);
        const large = (a2 - a1) > Math.PI ? 1 : 0;
        return `M ${x1} ${y1} L ${x2} ${y2} A ${r2} ${r2} 0 ${large} 1 ${x3} ${y3} L ${x4} ${y4} A ${r1} ${r1} 0 ${large} 0 ${x1} ${y1} Z`;
      };
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', arcPath(cx, cy, inR, outR, a1, a2));
      path.setAttribute('fill', fill);
      const opacity = 0.2 + (0.8 * (stress - 1) / 4);
      path.setAttribute('opacity', String(opacity));
      path.setAttribute('stroke', 'rgba(255,255,255,.25)');
      path.setAttribute('stroke-width', '.6');
      gCells.appendChild(path);
      const midA = (a1 + a2) / 2, midR = (inR + outR) / 2;
      const sx = cx + Math.cos(midA) * midR;
      const sy = cy + Math.sin(midA) * midR; 
      const sym = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      sym.setAttribute('x', sx);
      sym.setAttribute('y', sy);
      sym.setAttribute('text-anchor', 'middle');
      sym.setAttribute('dominant-baseline', 'middle');
      sym.setAttribute('font-size', '10');
      sym.setAttribute('font-weight', '700');
      sym.setAttribute('fill', '#1F2937');
      const ttype = (trip.tripType || '').toLowerCase();
      sym.textContent = ttype === 'work' ? '‚óè' : ttype === 'study' ? '‚òÖ' : '‚ñ≤';
      gCells.appendChild(sym);
      const tt = document.createElementNS('http://www.w3.org/2000/svg', 'title');
      tt.textContent = [
        `${trip.date || ''} @ ${trip.departureTime || '-'}`,
        `Mode: ${trip.mode?.replace('_', ' / ') || ''}`,
        `Purpose: ${trip.tripType || '-'}`,
        `CO‚ÇÇ: ${(trip.co2 || 0).toFixed(3)} kg`,
        `Stress: ${trip.stressLevel ?? '-'} / 5`
      ].join('\n');
      path.appendChild(tt);
    }
    function renderTimeline(){
      try{
        const svg = document.getElementById('timeline-svg');
        if(!svg) return;
        if (svg.replaceChildren) svg.replaceChildren(); else while (svg.firstChild) svg.removeChild(svg.firstChild);
        const cx=400, cy=400;
        const innerR = 40;
        const ringW  = 52;
        const padDeg = 0.5;
        const days   = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        const hours  = 24;
        const outerR = innerR + ringW*7;
        const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
        const dayIdx=(s)=>{ const d=new Date((s||'')+'T00:00:00'); return (d.getDay()+6)%7; };
        const hourOf=(s)=>{ if(!s) return 0; const [h,m]=String(s).split(':').map(Number); return (h||0)+((m||0)/60); };
        const rad=(deg)=>deg*Math.PI/180;
        const arcPath=(cx,cy,r1,r2,a1,a2)=>{ 
          const x1 = cx + r1*Math.cos(a1), y1 = cy + r1*Math.sin(a1);
          const x2 = cx + r2*Math.cos(a1), y2 = cy + r2*Math.sin(a1);
          const x3 = cx + r2*Math.cos(a2), y3 = cy + r2*Math.sin(a2);
          const x4 = cx + r1*Math.cos(a2), y4 = cy + r1*Math.sin(a2);
          const large = (a2-a1) > Math.PI ? 1 : 0;
          return `M ${x1} ${y1} L ${x2} ${y2} A ${r2} ${r2} 0 ${large} 1 ${x3} ${y3} L ${x4} ${y4} A ${r1} ${r1} 0 ${large} 0 ${x1} ${y1} Z`;
        };
        const gGrid  = document.createElementNS('http://www.w3.org/2000/svg','g');
        const gCells = document.createElementNS('http://www.w3.org/2000/svg','g');
        svg.appendChild(gGrid);
        svg.appendChild(gCells);
        const center = document.createElementNS('http://www.w3.org/2000/svg','circle');
        center.setAttribute('cx',cx); center.setAttribute('cy',cy);
        center.setAttribute('r', innerR);
        center.setAttribute('fill','none');
        center.setAttribute('stroke','#CBD5E1');
        center.setAttribute('stroke-width','1.2');
        gGrid.appendChild(center);
        const spokeEnd = outerR - (ringW*0.1);
        for (let h=0; h<24; h++){
          const a = rad((h/24)*360 - 90);
          const x1 = cx + Math.cos(a)*(innerR+2);
          const y1 = cy + Math.sin(a)*(innerR+2);
          const x2 = cx + Math.cos(a)*spokeEnd;
          const y2 = cy + Math.sin(a)*spokeEnd;
          const line = document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1',x1); line.setAttribute('y1',y1);
          line.setAttribute('x2',x2); line.setAttribute('y2',y2);
          line.setAttribute('class','hour-line ' + (h===0 ? 'midnight' : 'regular'));
          line.setAttribute('stroke-opacity', h===0 ? '0.4' : '0.8'); 
          gGrid.appendChild(line);
        }
        for(let h=0; h<24; h++){
          const a = rad((h/24)*360 - 90);
          const rr = outerR + 10;
          const x = cx + Math.cos(a)*rr, y = cy + Math.sin(a)*rr;
          const t = document.createElementNS('http://www.w3.org/2000/svg','text');
          t.setAttribute('x',x); t.setAttribute('y',y);
          t.setAttribute('class','time-label');
          t.setAttribute('font-size', '9px'); 
          t.textContent = h;
          gGrid.appendChild(t);
        }
        for(let d=0; d<7; d++){
          const rMid = innerR + (d+0.5)*ringW;
          const lab = document.createElementNS('http://www.w3.org/2000/svg','text');
          lab.setAttribute('x', cx);
          lab.setAttribute('y', cy - rMid);
          lab.setAttribute('class','day-label');
          lab.textContent = days[d];
          gGrid.appendChild(lab);
          const ringLine = document.createElementNS('http://www.w3.org/2000/svg','circle');
          ringLine.setAttribute('cx',cx); ringLine.setAttribute('cy',cy);
          ringLine.setAttribute('r', innerR + d*ringW);
          ringLine.setAttribute('class','ring-sep');
          gGrid.appendChild(ringLine);
        }
        if(!Array.isArray(trips) || !trips.length){
          renderLegend(0); 
          return;
        }
        const grid = Array.from({length:7}, ()=> Array(25).fill(null).map(() => [])); 
        trips.forEach(t=>{
          if(typeof VISIBLE_MODES !== 'undefined' && !VISIBLE_MODES.includes(t.mode)) return;
          const d=new Date((t.date||'')+'T00:00:00');
          let di = (d.getDay()+6)%7;
          const h_start = hourOf(t.departureTime||'00:00');
          const h_end = hourOf(t.arrivalTime||'00:00');
          let h = Math.floor(h_start);
          if(h<0 || di<0 || di>6) return;
          if (h_start < h_end) { 
            h = Math.floor(h_start);
          } else if (h_start > h_end) { 
            if (h_start < 4) { 
               di = (di - 1 + 7) % 7;
               h = 24; 
            }
          }
          h = Math.floor(h);
          if(h<0 || h>24 || di<0 || di>6) return;
          grid[di][h].push(t);
        });
        for (let d = 0; d < 7; d++) {
          for (let h = 0; h < 25; h++) { 
            if (grid[d][h].length > 1) {
              grid[d][h] = grid[d][h]
                .sort((a, b) => (+b.co2 || 0) - (+a.co2 || 0)) 
                .slice(0, 2); 
            }
          }
        }
        const allTripsInGrid = grid.flat(2).filter(Boolean);
        const maxCO2 = Math.max(0.001, ...allTripsInGrid.map(t=> +t.co2||0));
        for(let d=0; d<7; d++){
          const rOuter = innerR + (d+1)*ringW;
          const rInner = rOuter - ringW;
          for(let h=0; h<24; h++){
            const tripsInSlot = grid[d][h]; 
            if(tripsInSlot.length === 0) continue; 
            const a1 = rad((h/24)*360 - 90 + padDeg);
            const a2 = rad(((h+1)/24)*360 - 90 - padDeg);
            if(tripsInSlot.length === 1) {
              drawArc(tripsInSlot[0], a1, a2, rInner, rOuter, maxCO2, gCells, cx, cy, ringW);
            } 
            else if (tripsInSlot.length === 2) {
              const a_mid = (a1 + a2) / 2;
              const padRad = rad(padDeg / 2);
              drawArc(tripsInSlot[0], a1, a_mid - padRad, rInner, rOuter, maxCO2, gCells, cx, cy, ringW);
              drawArc(tripsInSlot[1], a_mid + padRad, a2, rInner, rOuter, maxCO2, gCells, cx, cy, ringW);
            }
          }
          const overnightTrips = grid[d][24];
          if (overnightTrips.length > 0) {
              const h = 0; 
              const a1 = rad((h/24)*360 - 90 + padDeg);
              const a2 = rad(((h+1)/24)*360 - 90 - padDeg);
              if(overnightTrips.length === 1) {
                 drawArc(overnightTrips[0], a1, a2, rInner, rOuter, maxCO2, gCells, cx, cy, ringW);
              } else {
                 const a_mid = (a1 + a2) / 2;
                 const padRad = rad(padDeg / 2);
                 drawArc(overnightTrips[0], a1, a_mid - padRad, rInner, rOuter, maxCO2, gCells, cx, cy, ringW);
                 drawArc(overnightTrips[1], a_mid + padRad, a2, rInner, rOuter, maxCO2, gCells, cx, cy, ringW);
              }
          }
        }
        const rim = document.createElementNS('http://www.w3.org/2000/svg','circle');
        rim.setAttribute('cx',cx); rim.setAttribute('cy',cy);
        rim.setAttribute('r', outerR);
        rim.setAttribute('fill','none');
        rim.setAttribute('stroke','#CBD5E1');
        rim.setAttribute('stroke-width','1.4');
        gGrid.appendChild(rim);
        renderLegend(maxCO2);
      }catch(err){
        console.error('[Timeline] render error:', err);
      }
    }
    // Legend
    function renderLegend(maxCO2_raw){
      const legendModes = document.getElementById('legend-modes');
      if (legendModes){
        legendModes.innerHTML = '';
        const modes = (typeof VISIBLE_MODES!=='undefined' ? VISIBLE_MODES : ['Car_driver','Car_passenger','Metro','Bus']);
        const colors= (typeof MODE_COLORS!=='undefined' ? MODE_COLORS : {
          Car_driver:'#ef4444', Car_passenger:'#f59e0b', Metro:'#60a5fa', Bus:'#38bdf8'
        });
        modes.forEach(m=>{
          const div = document.createElement('div');
          div.className = 'legend-item';
          div.innerHTML = `<span class="legend-swatch" style="background:${colors[m]||'#999'}"></span> ${m.replace('_',' / ')}`;
          legendModes.appendChild(div);
        });
      }
      const legendPurpose = document.getElementById('legend-purpose');
      if (legendPurpose){
        legendPurpose.innerHTML = `
          <li><span class="symbol">‚óè</span>Work</li>
          <li><span class="symbol">‚òÖ</span>Study</li>
          <li><span class="symbol">‚ñ≤</span>Other (Leisure, Commute, etc.)</li>
        `;
      }
      const co2Wrap = document.getElementById('legend-co2');
      if (co2Wrap) {
          const maxCO2 = maxCO2_raw > 0 ? maxCO2_raw : 1.0; 
          const baseH = 52 * 0.8; 
          const minFrac = 0.2;
          const anchors = [
              { frac: 0,    label: "0.00 kg" },
              { frac: 0.33, label: `${(maxCO2 * 0.33).toFixed(2)} kg` },
              { frac: 0.66, label: `${(maxCO2 * 0.66).toFixed(2)} kg` },
              { frac: 1.0,  label: `${(maxCO2).toFixed(2)} kg` }
          ];
          co2Wrap.innerHTML = anchors.map(a => {
              const visualFrac = Math.max(minFrac, Math.sqrt(a.frac));
              const height = baseH * visualFrac;
              return `
                  <div class="co2-bin">
                      <div class="co2-block" style="height: ${height.toFixed(1)}px;"></div>
                      <div class="co2-label">${a.label}</div>
                  </div>
              `;
          }).join('');
      }
    }

    // =============== INSIGHTS =================
    const PRIMARY_COLOR = '#4F46E5';
    const STRESS_COLORSCALE = [
      [0, '#3b82f6'],    // 1 (min)
      [0.25, '#93c5fd'], // 2
      [0.5, '#fde047'],  // 3
      [0.75, '#f97316'], // 4
      [1, '#ef4444']     // 5 (max)
    ];
    let crossFilters = { mode: null, purpose: null, day: null };
    function sumBy(rows, key, valueKey) {
      const result = {};
      rows.forEach(r => {
        const k = r[key] || 'Other';
        const v = +r[valueKey] || 0;
        if (!result[k]) result[k] = 0;
        result[k] += v;
      });
      return result;
    }
    function avgBy(rows, key, valueKey) {
      const sums = {}; const counts = {};
      rows.forEach(r => {
        const k = r[key] || 'Other';
        const v = (key === 'stressLevel' && r[valueKey]) ? +r[valueKey] : (+r[valueKey] || 0);
        if (r[key] !== undefined && r[valueKey] !== undefined) {
             if (!sums[k]) { sums[k] = 0; counts[k] = 0; }
            sums[k] += v;
            counts[k]++;
        }
      });
      const result = {};
      for (const k in sums) {
        result[k] = (counts[k] > 0) ? (sums[k] / counts[k]) : 0;
      }
      return result;
    }
    function aggregateByDayOfWeek(rows, valueKey, aggType = 'sum') {
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const result = {};
      const sums = {}; const counts = {};
      days.forEach(day => { sums[day] = 0; counts[day] = 0; });
      rows.forEach(r => {
        if (!r.date || !r.dayName) return;
        const dayName = r.dayName;
        if (dayName) {
          sums[dayName] += (r[valueKey] || 0);
          counts[dayName]++;
        }
      });
      if (aggType === 'sum') {
        days.forEach(day => { result[day] = sums[day]; });
      } else { 
        days.forEach(day => { result[day] = counts[day] > 0 ? sums[day] / counts[day] : 0; });
      }
      return result;
    }
    function aggregateForHeatmap(rows, valueKey) {
      const yLabels = ['Sun', 'Sat', 'Fri', 'Thu', 'Wed', 'Tue', 'Mon'];
      const xLabels = ['Night (0-5)', 'Morning (6-9)', 'Midday (10-13)', 'Afternoon (14-17)', 'Evening (18-23)'];
      const sums = Array(yLabels.length).fill(0).map(() => Array(xLabels.length).fill(0));
      const counts = Array(yLabels.length).fill(0).map(() => Array(xLabels.length).fill(0));
      const dayIndexMap = {'Mon': 6, 'Tue': 5, 'Wed': 4, 'Thu': 3, 'Fri': 2, 'Sat': 1, 'Sun': 0};
      rows.forEach(r => {
        if (!r.date || !r.departureTime || !r.dayName) return;
        const dayIndex = dayIndexMap[r.dayName];
        const hour = parseInt(r.departureTime.split(':')[0], 10);
        let binIndex;
        if (hour <= 5) binIndex = 0;
        else if (hour <= 9) binIndex = 1;
        else if (hour <= 13) binIndex = 2;
        else if (hour <= 17) binIndex = 3;
        else binIndex = 4;
        sums[dayIndex][binIndex] += (r[valueKey] || 0);
        counts[dayIndex][binIndex]++;
      });
      const zValues = sums.map((row, i) => 
        row.map((sum, j) => 
          counts[i][j] > 0 ? (sum / counts[i][j]) : null
        )
      );
      return { z: zValues, x: xLabels, y: yLabels };
    }
    function applyCrossFilters(rows, filters) {
      const { mode, purpose, day } = filters;
      if (!mode && !purpose && !day) return rows;
      return rows.filter(r => {
        const modeMatch = !mode || r.mode === mode;
        const purposeMatch = !purpose || r.tripType === purpose;
        const dayMatch = !day || r.dayName === day;
        return modeMatch && purposeMatch && dayMatch;
      });
    }
    function setText(id,v){ const el = $('#'+id); if(el) el.textContent=v; }
    function computeMetrics(rows){
      const n = rows.length;
      const totCO2 = rows.reduce((s,r)=>s+(+r.co2||0),0);
      const km = rows.reduce((s,r)=>s+(+r.distance||0),0);
      const avgStress = n ? rows.reduce((s,r)=>s+(+r.stressLevel||0),0)/n : 0;
      const co2gkm = km ? (totCO2 * 1000) / km : 0;
      const co2PerKm = km ? totCO2 / km : 0;
      let score = clamp(100 - Math.min(60, 100*co2PerKm) - 5*avgStress, 0, 100);
      return {n, totCO2, km, avgStress, co2gkm, score};
    }
    const PLOTLY_CONFIG = {
      responsive: true,
      displayModeBar: false
    };
    const PLOTLY_LAYOUT = {
      font: {
        family: "'Lexend', ui-sans-serif, system-ui",
        color: '#6B7280',
        size: 12
      },
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      margin: { l: 50, r: 20, t: 20, b: 40 },
      xaxis: {
        gridcolor: '#F3F4F6',
        zeroline: false
      },
      yaxis: {
        gridcolor: '#F3F4F6',
        zeroline: false
      }
    };
    function renderInsights(base){
      if (typeof Plotly === 'undefined') {
        console.error('Plotly library not loaded');
        return;
      }
      if (!Array.isArray(base) || base.length < 3) {
        return;
      }
      const m = computeMetrics(base);
      setText('kix-kpi-trips', String(m.n));
      setText('kix-kpi-co2', `${m.totCO2.toFixed(2)} kg`);
      setText('kix-kpi-stress', `${m.avgStress.toFixed(1)} / 5`);
      setText('kix-kpi-gkm', `${m.co2gkm.toFixed(0)} g/km`);
      setText('kix-kpi-score', `${m.score.toFixed(0)}`);
      const clearButton = $('#clear-cross-filters');
      clearButton.style.display = (crossFilters.mode || crossFilters.purpose || crossFilters.day) ? 'inline-block' : 'none';
      if (crossFilters.day) {
        clearButton.textContent = `Filter: ${crossFilters.day} (Reset)`;
      } else if (crossFilters.mode) {
        clearButton.textContent = `Filter: ${crossFilters.mode.replace('_',' / ')} (Reset)`;
      } else if (crossFilters.purpose) {
        clearButton.textContent = `Filter: ${crossFilters.purpose} (Reset)`;
      }
      const filteredRows = applyCrossFilters(base, crossFilters);
      const dataForStressMode = applyCrossFilters(base, { purpose: crossFilters.purpose, day: crossFilters.day });
      const dataForStressPurpose = applyCrossFilters(base, { mode: crossFilters.mode, day: crossFilters.day });
      const dataForCO2Mode = applyCrossFilters(base, { purpose: crossFilters.purpose, day: crossFilters.day });
      const dataForViolin = applyCrossFilters(base, { purpose: crossFilters.purpose, day: crossFilters.day });
      renderStressHeatmap(filteredRows);
      renderCO2ByDay(filteredRows);
      renderCO2PieChart(dataForCO2Mode);
      renderStressByMode(dataForStressMode);
      renderStressByPurpose(dataForStressPurpose);
      renderEfficiencyVsStress(base);
    }
    function renderStressHeatmap(rows) {
      const chartDiv = 'stress-heatmap-chart';
      const { z, x, y } = aggregateForHeatmap(rows, 'stressLevel');
      const data = [{
        z: z,
        x: x,
        y: y,
        type: 'heatmap',
        colorscale: STRESS_COLORSCALE,
        zmin: 1,
        zmax: 5,
        showscale: true,
        colorbar: {
          title: 'Stress',
          titleside: 'right',
          ticks: 'outside',
          tickvals: [1, 2, 3, 4, 5]
        }
      }];
      let layout = JSON.parse(JSON.stringify(PLOTLY_LAYOUT));
      layout.margin.l = 80;
      layout.margin.b = 60;
      layout.xaxis.side = 'top';
      Plotly.newPlot(chartDiv, data, layout, PLOTLY_CONFIG);
      const plotEl = document.getElementById(chartDiv);
      plotEl.removeAllListeners('plotly_click');
      plotEl.on('plotly_click', (data) => {
        if (data.points.length > 0) {
          const clickedLabel = data.points[0].y;
          crossFilters.day = (crossFilters.day === clickedLabel) ? null : clickedLabel;
          crossFilters.mode = null; crossFilters.purpose = null;
          renderInsights(trips);
        }
      });
    }
    function renderCO2ByDay(rows) {
      const chartDiv = 'co2-by-day-chart';
      const data = aggregateByDayOfWeek(rows, 'co2', 'sum');
      const labels = Object.keys(data);
      const plotData = [{
        x: labels,
        y: labels.map(l => data[l]),
        type: 'bar',
        marker: { color: PRIMARY_COLOR }
      }];
      let layout = JSON.parse(JSON.stringify(PLOTLY_LAYOUT));
      layout.yaxis.title = 'Total CO‚ÇÇ (kg)';
      layout.xaxis.tickangle = 0;
      Plotly.newPlot(chartDiv, plotData, layout, PLOTLY_CONFIG);
      const plotEl = document.getElementById(chartDiv);
      plotEl.removeAllListeners('plotly_click');
      plotEl.on('plotly_click', (data) => {
        if (data.points.length > 0) {
          const clickedLabel = data.points[0].x;
          crossFilters.day = (crossFilters.day === clickedLabel) ? null : clickedLabel;
          crossFilters.mode = null; crossFilters.purpose = null;
          renderInsights(trips);
        }
      });
    }
    function renderCO2PieChart(rows) {
      const chartDiv = 'co2-pie-chart';
      const data = sumBy(rows, 'mode', 'co2');
      const labels = Object.keys(data);
      const values = labels.map(l => data[l]);
      const plotData = [{
        labels: labels.map(l => l.replace('_',' / ')),
        values: values,
        type: 'pie',
        hole: 0.5,
        marker: {
          colors: labels.map(l => MODE_COLORS[l] || FALLBACK_COLOR)
        },
        textinfo: 'percent',
        textfont: { color: '#ffffff', size: 14, weight: 'bold' },
        hoverinfo: 'label+value',
        sort: false
      }];
      let layout = JSON.parse(JSON.stringify(PLOTLY_LAYOUT));
      layout.showlegend = true;
      layout.legend = { orientation: 'h', y: -0.1 };
      layout.margin = { l: 20, r: 20, t: 20, b: 50 };
      Plotly.newPlot(chartDiv, plotData, layout, PLOTLY_CONFIG);
      const plotEl = document.getElementById(chartDiv);
      plotEl.removeAllListeners('plotly_click');
      plotEl.on('plotly_click', (data) => {
        if (data.points.length > 0) {
          const clickedLabel = data.points[0].label.replace(' / ','_');
          crossFilters.mode = (crossFilters.mode === clickedLabel) ? null : clickedLabel;
          crossFilters.day = null; crossFilters.purpose = null;
          renderInsights(trips);
        }
      });
    }
    function renderStressByMode(rows) {
      const chartDiv = 'stress-by-mode-chart';
      const data = avgBy(rows, 'mode', 'stressLevel');
      const labels = Object.keys(data);
      const plotData = [{
        x: labels.map(l => l.replace('_',' / ')),
        y: labels.map(l => data[l]),
        type: 'bar',
        marker: {
          color: labels.map(l => MODE_COLORS[l] || FALLBACK_COLOR)
        }
      }];
      let layout = JSON.parse(JSON.stringify(PLOTLY_LAYOUT));
      layout.yaxis.title = 'Average Stress (1-5)';
      layout.yaxis.range = [0, 5];
      layout.xaxis.tickangle = 0;
      layout.xaxis.automargin = true;
      Plotly.newPlot(chartDiv, plotData, layout, PLOTLY_CONFIG);
      const plotEl = document.getElementById(chartDiv);
      plotEl.removeAllListeners('plotly_click');
      plotEl.on('plotly_click', (data) => {
        if (data.points.length > 0) {
          const clickedLabel = data.points[0].x.replace(' / ','_');
          crossFilters.mode = (crossFilters.mode === clickedLabel) ? null : clickedLabel;
          crossFilters.day = null; crossFilters.purpose = null;
          renderInsights(trips);
        }
      });
    }
    function renderStressByPurpose(rows) {
      const chartDiv = 'stress-by-purpose-chart';
      const data = avgBy(rows, 'tripType', 'stressLevel');
      const labels = Object.keys(data);
      
      const plotData = [{
        x: labels,
        y: labels.map(l => data[l]),
        type: 'bar',
        marker: {
          color: PRIMARY_COLOR 
        }
      }];
      let layout = JSON.parse(JSON.stringify(PLOTLY_LAYOUT));
      layout.yaxis.title = 'Average Stress (1-5)';
      layout.yaxis.range = [0, 5];
      layout.xaxis.tickangle = 0;
      layout.xaxis.automargin = true;
      Plotly.newPlot(chartDiv, plotData, layout, PLOTLY_CONFIG);
      const plotEl = document.getElementById(chartDiv);
      plotEl.removeAllListeners('plotly_click');
      plotEl.on('plotly_click', (data) => {
        if (data.points.length > 0) {
          const clickedLabel = data.points[0].x;
          crossFilters.purpose = (crossFilters.purpose === clickedLabel) ? null : clickedLabel;
          crossFilters.day = null; crossFilters.mode = null;
          renderInsights(trips);
        }
      });
    }
    function renderEfficiencyVsStress(rows) {
      const chartDiv = 'efficiency-stress-chart';
      const avgStressByMode = avgBy(rows, 'mode', 'stressLevel');
      const totalCO2ByMode = sumBy(rows, 'mode', 'co2');
      const totalDistanceByMode = sumBy(rows, 'mode', 'distance');
      const modes = [...new Set(rows.map(r => r.mode))].filter(Boolean);
      const plot_x = []; // Efficienza (g/km)
      const plot_y = []; // Avg. Stress (1-5)
      const plot_labels = [];
      const plot_colors = []; 
      for (const mode of modes) {
        const totalDist = totalDistanceByMode[mode] || 0;
        const totalCO2 = totalCO2ByMode[mode] || 0;
        const avgStress = avgStressByMode[mode] || 0;
        const efficiency_gkm = (totalDist > 0) ? (totalCO2 * 1000) / totalDist : 0;
        if (avgStress > 0 && totalDist > 0) {
          plot_x.push(efficiency_gkm);
          plot_y.push(avgStress);
          plot_labels.push(mode.replace('_', ' / '));
          plot_colors.push(MODE_COLORS[mode] || FALLBACK_COLOR);
        }
      }
      const plotData = [{
        x: plot_x,
        y: plot_y,
        text: plot_labels,
        type: 'scatter',
        mode: 'markers+text', 
        textposition: 'top center',
        marker: {
          color: plot_colors,
          size: 14,
          line: { color: 'rgba(255,255,255,0.6)', width: 2 }
        },
        hoverinfo: 'x+y+text'
      }];
      let layout = JSON.parse(JSON.stringify(PLOTLY_LAYOUT));
      layout.xaxis.title = 'Avg. Efficiency (CO‚ÇÇ g/km)';
      layout.yaxis.title = 'Average Stress (1-5)';
      layout.yaxis.range = [0.5, 5.5];
      layout.xaxis.zeroline = true;
      layout.yaxis.zeroline = true;
      layout.showlegend = false;
      layout.margin.t = 40; 
      Plotly.newPlot(chartDiv, plotData, layout, PLOTLY_CONFIG);
    }
    function initFilters(base){
      const clearCrossBtn = document.getElementById('clear-cross-filters');
      if (clearCrossBtn && !clearCrossBtn.dataset.listener) {
        clearCrossBtn.addEventListener('click', () => {
          crossFilters = { mode: null, purpose: null, day: null };
          renderInsights(base);
        });
        clearCrossBtn.dataset.listener = 'true';
      }
    }

    // =============== INIT ================
    document.addEventListener('DOMContentLoaded', ()=>{
      initNav();
      initEntryForm();
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      trips.forEach(t => {
        if (t.date) {
          const d = new Date(t.date + 'T00:00:00');
          t.dayName = days[d.getDay()];
        }
      });
      trips.sort((a, b) => {
        const dateA = new Date(String(a.date) + 'T' + String(a.departureTime));
        const dateB = new Date(String(b.date) + 'T' + String(b.departureTime));
        if (isNaN(dateA) || isNaN(dateB)) return 0;
        return dateA - dateB;
      });
      saveTrips(trips);
      renderDataset();
    });
  </script>
</body>
</html>
